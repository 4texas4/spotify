<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Spotify Playlist YouTube Player (Lazy Load YT)</title>
<style>
  body {
    background: #000; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 1rem;
    max-width: 900px; margin-left: auto; margin-right: auto;
  }
  h1 {
    text-align: center; margin-bottom: 1rem;
  }
  #inputSection {
    text-align: center; margin-bottom: 1.5rem;
  }
  input[type=text] {
    width: 80%; max-width: 500px; padding: 0.8rem; font-size: 1rem; border-radius: 8px;
    border: none;
  }
  button {
    padding: 0.8rem 1.2rem; font-size: 1rem; border-radius: 8px; border: none;
    background-color: #1db954; color: #000; cursor: pointer; margin-left: 0.5rem;
  }
  #trackList {
    display: flex; flex-direction: column; gap: 1rem;
  }
  .track-item {
    background: #111; padding: 0.8rem; border-radius: 10px; cursor: pointer;
  }
  .track-title {
    font-weight: bold; font-size: 1.1rem; margin: 0;
  }
  .track-artist {
    font-size: 0.9rem; color: #aaa; margin: 0;
  }
  #playerControls {
    margin-top: 2rem; background: #111; padding: 1rem; border-radius: 12px;
    display: none; flex-direction: column; align-items: center;
  }
  #playerTitle {
    font-weight: bold; margin-bottom: 0.5rem;
  }
  #progressContainer {
    width: 100%; background: #555; height: 10px; border-radius: 6px; cursor: pointer;
    margin-bottom: 0.5rem;
  }
  #progressBar {
    height: 100%; width: 0%; background: #1db954; border-radius: 6px;
  }
  #timeDisplay {
    margin-bottom: 0.8rem;
  }
  #controls {
    display: flex; gap: 1rem;
  }
  #controls button {
    padding: 0.6rem 1rem; border: none; border-radius: 8px; background: #222;
    color: white; cursor: pointer; font-size: 1rem;
  }
  iframe {
    display: none;
  }
</style>
</head>
<body>

<h1>Spotify Playlist YouTube Player (Lazy Load YT)</h1>

<div id="inputSection">
  <input type="text" id="playlistInput" placeholder="Paste Spotify public playlist URL here" />
  <button id="loadPlaylistBtn">Load Playlist</button>
</div>

<div id="trackList"></div>

<div id="playerControls">
  <div id="playerTitle"></div>
  <div id="progressContainer"><div id="progressBar"></div></div>
  <div id="timeDisplay">0:00 / 0:00</div>
  <div id="controls">
    <button id="prevBtn">⏮</button>
    <button id="playPauseBtn">⏸</button>
    <button id="nextBtn">⏭</button>
    <button id="downloadBtn">⬇</button>
  </div>
</div>

<div id="youtubePlayers"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
  let spotifyToken = '';
  let tracks = [];
  let youtubePlayers = [];
  let currentTrackIndex = -1;
  let progressInterval = null;

  // Extract playlist ID from Spotify URL
  function getPlaylistId(url) {
    const m = url.match(/playlist\/([a-zA-Z0-9]+)/);
    return m ? m[1] : null;
  }

  // Fetch token from your backend
  async function fetchSpotifyToken() {
    const res = await fetch('/api/token');
    if (!res.ok) throw new Error('Failed to fetch Spotify token');
    const data = await res.json();
    return data.access_token;
  }

  // Fetch playlist tracks
  async function fetchSpotifyPlaylistTracks(playlistId) {
    let allTracks = [];
    let offset = 0;
    const limit = 50;
    while (true) {
      const res = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks?offset=${offset}&limit=${limit}`, {
        headers: { Authorization: 'Bearer ' + spotifyToken }
      });
      if (!res.ok) throw new Error('Failed to fetch playlist tracks');
      const data = await res.json();
      allTracks = allTracks.concat(data.items);
      if (!data.next) break;
      offset += limit;
    }
    return allTracks;
  }

  // Search YouTube on demand via corsproxy.io
  async function searchYouTube(query) {
    const cors = 'https://corsproxy.io/?';
    const url = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}+lyrics`;
    try {
      const res = await fetch(cors + url);
      const text = await res.text();
      const videoRegex = /"videoRenderer":\s*{(.*?)"videoId":"(.*?)"/s;
      const match = videoRegex.exec(text);
      return match ? match[2] : null;
    } catch {
      return null;
    }
  }

  // Create YT Player
  function createYTPlayer(videoId, index) {
    const divId = `ytplayer${index}`;
    const container = document.getElementById('youtubePlayers');
    let div = document.getElementById(divId);
    if (!div) {
      div = document.createElement('div');
      div.id = divId;
      container.appendChild(div);
    }

    return new YT.Player(divId, {
      height: '0',
      width: '0',
      videoId: videoId,
      playerVars: {
        autoplay: 0,
        controls: 0,
        disablekb: 1,
        modestbranding: 1,
        rel: 0,
        showinfo: 0,
        iv_load_policy: 3
      },
      events: {
        onReady: () => {},
        onStateChange: (e) => {
          if (e.data === YT.PlayerState.ENDED) {
            playNextTrack();
          }
        }
      }
    });
  }

  // Render playlist names only (no YT data)
  function renderPlaylist() {
    const list = document.getElementById('trackList');
    list.innerHTML = '';
    tracks.forEach((item, i) => {
      const track = item.track;
      const div = document.createElement('div');
      div.className = 'track-item';
      div.dataset.index = i;
      div.innerHTML = `
        <p class="track-title">${track.name}</p>
        <p class="track-artist">${track.artists.map(a => a.name).join(', ')}</p>
      `;
      div.addEventListener('click', () => playTrack(i));
      list.appendChild(div);
    });
  }

  // Play track (lazy load YT videoId)
  async function playTrack(index) {
    if (index < 0 || index >= tracks.length) return;
    if (currentTrackIndex === index) return;

    // Pause current
    if (currentTrackIndex !== -1 && youtubePlayers[currentTrackIndex]) {
      youtubePlayers[currentTrackIndex].pauseVideo();
    }

    currentTrackIndex = index;
    const track = tracks[index].track;

    // If we don't have videoId cached, search it now
    if (!tracks[index].videoId) {
      const query = `${track.name} ${track.artists.map(a => a.name).join(', ')}`;
      const videoId = await searchYouTube(query);
      if (!videoId) {
        alert('YouTube video not found for this track.');
        return;
      }
      tracks[index].videoId = videoId;
    }

    // Create player if needed
    if (!youtubePlayers[index]) {
      youtubePlayers[index] = createYTPlayer(tracks[index].videoId, index);
      // Wait for player to be ready and play
      const interval = setInterval(() => {
        if (youtubePlayers[index].getPlayerState() !== -1) {
          youtubePlayers[index].playVideo();
          clearInterval(interval);
        }
      }, 100);
    } else {
      youtubePlayers[index].playVideo();
    }

    updatePlayerUI();
  }

  function updatePlayerUI() {
    const controls = document.getElementById('playerControls');
    controls.style.display = 'flex';

    const titleDiv = document.getElementById('playerTitle');
    const currentTrack = tracks[currentTrackIndex].track;
    titleDiv.textContent = `${currentTrack.name} — ${currentTrack.artists.map(a => a.name).join(', ')}`;

    updateProgress();
    startProgressUpdater();

    const playPauseBtn = document.getElementById('playPauseBtn');
    playPauseBtn.textContent = '⏸';
  }

  function updateProgress() {
    if (currentTrackIndex === -1) return;
    const player = youtubePlayers[currentTrackIndex];
    if (!player || !player.getDuration) return;

    const duration = player.getDuration();
    const currentTime = player.getCurrentTime();
    if (duration > 0) {
      const percent = (currentTime / duration) * 100;
      document.getElementById('progressBar').style.width = percent + '%';
      document.getElementById('timeDisplay').textContent = formatTime(currentTime) + ' / ' + formatTime(duration);
    }
  }

  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return m + ':' + (s < 10 ? '0' : '') + s;
  }

  function seek(event) {
    if (currentTrackIndex === -1) return;
    const progressContainer = event.currentTarget;
    const rect = progressContainer.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percent = clickX / progressContainer.offsetWidth;

    const player = youtubePlayers[currentTrackIndex];
    const duration = player.getDuration();
    player.seekTo(duration * percent, true);
  }

  function startProgressUpdater() {
    clearInterval(progressInterval);
    progressInterval = setInterval(updateProgress, 500);
  }

  function togglePlayPause() {
    if (currentTrackIndex === -1) return;
    const player = youtubePlayers[currentTrackIndex];
    const btn = document.getElementById('playPauseBtn');

    if (player.getPlayerState() === YT.PlayerState.PLAYING) {
      player.pauseVideo();
      btn.textContent = '▶';
    } else {
      player.playVideo();
      btn.textContent = '⏸';
    }
  }

  function playPrevTrack() {
    if (currentTrackIndex > 0) playTrack(currentTrackIndex - 1);
  }

  function playNextTrack() {
    if (currentTrackIndex < tracks.length -1) playTrack(currentTrackIndex +1);
  }

  function downloadCurrentTrack() {
    if (currentTrackIndex === -1) return;
    const videoId = tracks[currentTrackIndex].videoId;
    window.open(`https://yt1d.com/en307/watch?v=${videoId}`, '_blank');
  }

  document.getElementById('loadPlaylistBtn').addEventListener('click', async () => {
    const url = document.getElementById('playlistInput').value.trim();
    const playlistId = getPlaylistId(url);
    if (!playlistId) return alert('Invalid Spotify playlist URL');

    try {
      document.getElementById('trackList').innerHTML = 'Loading playlist...';
      spotifyToken = await fetchSpotifyToken();
      const spotifyTracks = await fetchSpotifyPlaylistTracks(playlistId);
      tracks = spotifyTracks.filter(t => t.track != null);

      if (tracks.length === 0) {
        document.getElementById('trackList').innerHTML = '<p>No tracks found in this playlist.</p>';
        return;
      }

      renderPlaylist();
    } catch (e) {
      alert('Error loading playlist: ' + e.message);
      document.getElementById('trackList').innerHTML = '';
    }
  });

  document.getElementById('playPauseBtn').onclick = togglePlayPause;
  document.getElementById('prevBtn').onclick = playPrevTrack;
  document.getElementById('nextBtn').onclick = playNextTrack;
  document.getElementById('downloadBtn').onclick = downloadCurrentTrack;
  document.getElementById('progressContainer').onclick = seek;

  // YT iframe API callback
  function onYouTubeIframeAPIReady() {}

</script>

</body>
</html>
