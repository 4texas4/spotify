<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Spotify Playlist Viewer</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 2em auto; }
  input, button { width: 100%; padding: 10px; margin: 0.5em 0; font-size: 1em; }
  ul { list-style: none; padding: 0; }
  li { margin: 0.3em 0; }
</style>
</head>
<body>

<h2>Enter Spotify Public Playlist URL</h2>
<input id="playlistUrl" placeholder="Paste your Spotify playlist link here" />
<button id="loadBtn">Load Tracks</button>

<h3>Tracks:</h3>
<ul id="trackList"></ul>

<script>
  function extractPlaylistId(url) {
    const match = url.match(/playlist\/([a-zA-Z0-9]+)/);
    return match ? match[1] : null;
  }

  async function getToken() {
    const res = await fetch('/api/token');
    if (!res.ok) throw new Error('Failed to fetch token');
    const data = await res.json();
    return data.access_token;
  }

  async function fetchPlaylistTracks(playlistId, token) {
    let allTracks = [];
    let offset = 0;
    const limit = 100;

    while (true) {
      const res = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks?offset=${offset}&limit=${limit}`, {
        headers: { Authorization: 'Bearer ' + token }
      });
      if (!res.ok) throw new Error('Failed to fetch playlist tracks');
      const data = await res.json();
      allTracks = allTracks.concat(data.items);
      if (!data.next) break;
      offset += limit;
    }
    return allTracks;
  }

  async function loadPlaylist() {
    const url = document.getElementById('playlistUrl').value.trim();
    const trackList = document.getElementById('trackList');
    trackList.innerHTML = '';

    const playlistId = extractPlaylistId(url);
    if (!playlistId) {
      alert('Invalid Spotify playlist URL!');
      return;
    }

    try {
      document.getElementById('loadBtn').disabled = true;
      document.getElementById('loadBtn').textContent = 'Loading token...';

      const token = await getToken();

      document.getElementById('loadBtn').textContent = 'Loading tracks...';

      const tracks = await fetchPlaylistTracks(playlistId, token);

      tracks.forEach(item => {
        if (item.track) {
          const artists = item.track.artists.map(a => a.name).join(', ');
          const li = document.createElement('li');
          li.textContent = `${item.track.name} â€” ${artists}`;
          trackList.appendChild(li);
        }
      });

      if (tracks.length === 0) {
        trackList.textContent = 'No tracks found.';
      }
    } catch (err) {
      alert('Error: ' + err.message);
    } finally {
      document.getElementById('loadBtn').disabled = false;
      document.getElementById('loadBtn').textContent = 'Load Tracks';
    }
  }

  document.getElementById('loadBtn').addEventListener('click', loadPlaylist);
</script>

</body>
</html>
