<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spotify Playlist to YouTube Player</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: Arial, sans-serif;
      padding: 1rem;
      max-width: 900px;
      margin: auto;
    }
    input, button {
      padding: 0.5rem;
      font-size: 1rem;
      margin: 0.3rem 0;
      width: 100%;
      max-width: 600px;
      border-radius: 6px;
      border: none;
    }
    button {
      background: #1db954;
      color: black;
      cursor: pointer;
      font-weight: bold;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      cursor: pointer;
      padding: 0.5rem 0.3rem;
      border-bottom: 1px solid #333;
    }
    li:hover {
      background: #222;
    }
    #player {
      margin-top: 1rem;
      height: 100px;
      width: 100%;
      max-width: 600px;
    }
    #loading {
      margin: 1rem 0;
      font-weight: bold;
      color: #1db954;
    }
  </style>
</head>
<body>
  <h1>Spotify Playlist to YouTube Player</h1>
  <input type="text" id="playlistUrl" placeholder="Enter Spotify Playlist URL" />
  <button id="loadPlaylist">Load Playlist</button>
  <div id="loading"></div>
  <ul id="trackList"></ul>
  <div id="player"></div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let ytPlayer;
    let currentVideoId = null;

    // Fetch Spotify access token from your backend API
    async function getSpotifyToken() {
      const res = await fetch('/api/token');
      if (!res.ok) throw new Error('Failed to get Spotify token');
      const data = await res.json();
      return data.access_token;
    }

    // Parse playlist ID from Spotify URL
    function parsePlaylistId(url) {
      try {
        const u = new URL(url);
        if (u.hostname !== 'open.spotify.com') return null;
        const parts = u.pathname.split('/');
        if (parts[1] !== 'playlist') return null;
        return parts[2];
      } catch {
        return null;
      }
    }

    // Fetch playlist tracks from Spotify API using token
    async function fetchPlaylistTracks(token, playlistId) {
      let tracks = [];
      let url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`;
      while (url) {
        const res = await fetch(url, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Failed to fetch playlist tracks');
        const data = await res.json();
        tracks = tracks.concat(data.items);
        url = data.next; // pagination
      }
      return tracks;
    }

    // Search YouTube for song + artist, return first videoId or null
    async function searchYouTube(query) {
      const cors = 'https://corsproxy.io/?';
      const searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}+lyrics`;
      const res = await fetch(cors + searchUrl);
      if (!res.ok) return null;
      const html = await res.text();

      // regex to find first videoRenderer and extract videoId
      const videoRegex = /"videoRenderer":\s*{(.*?)"videoId":"(.*?)"/s;
      const match = videoRegex.exec(html);
      if (match && match[2]) return match[2];
      return null;
    }

    // Initialize YouTube player iframe
    function createYouTubePlayer(videoId) {
      if (ytPlayer) ytPlayer.destroy();

      ytPlayer = new YT.Player('player', {
        height: '90',
        width: '100%',
        videoId,
        playerVars: { autoplay: 1, controls: 1 },
        events: {
          onReady: () => ytPlayer.playVideo(),
          onStateChange: (event) => {
            if (event.data === YT.PlayerState.ENDED) {
              // Optionally handle track end
            }
          }
        }
      });
      currentVideoId = videoId;
    }

    // Main logic on button click
    document.getElementById('loadPlaylist').onclick = async () => {
      const url = document.getElementById('playlistUrl').value.trim();
      const playlistId = parsePlaylistId(url);
      const loadingDiv = document.getElementById('loading');
      const trackList = document.getElementById('trackList');
      loadingDiv.textContent = '';
      trackList.innerHTML = '';
      document.getElementById('player').innerHTML = '';

      if (!playlistId) {
        alert('Invalid Spotify playlist URL');
        return;
      }

      loadingDiv.textContent = 'Getting Spotify token...';

      try {
        const token = await getSpotifyToken();

        loadingDiv.textContent = 'Fetching playlist tracks...';

        const tracks = await fetchPlaylistTracks(token, playlistId);

        if (!tracks.length) {
          loadingDiv.textContent = 'No tracks found in playlist.';
          return;
        }

        loadingDiv.textContent = `Found ${tracks.length} tracks. Searching YouTube...`;

        // Prepare track list with YouTube videoIds
        // For performance, you can limit or add concurrency control
        const tracksWithVideos = [];

        for (let i = 0; i < tracks.length; i++) {
          const t = tracks[i].track;
          if (!t) continue;
          const query = `${t.name} ${t.artists.map(a => a.name).join(' ')}`;
          loadingDiv.textContent = `Searching YouTube for: ${query} (${i + 1}/${tracks.length})`;

          const videoId = await searchYouTube(query);
          tracksWithVideos.push({ title: t.name, artists: t.artists, videoId });
        }

        loadingDiv.textContent = '';

        // Display track list clickable to play video
        trackList.innerHTML = tracksWithVideos.map((t, i) => {
          const artistNames = t.artists.map(a => a.name).join(', ');
          const disabledClass = t.videoId ? '' : 'style="color:gray;cursor:not-allowed;"';
          return `<li ${disabledClass} data-videoid="${t.videoId || ''}">${i + 1}. ${t.title} â€” ${artistNames}</li>`;
        }).join('');

        // Click handler to play video
        trackList.querySelectorAll('li').forEach(li => {
          li.onclick = () => {
            if (!li.dataset.videoid) return;
            createYouTubePlayer(li.dataset.videoid);
          };
        });

      } catch (e) {
        loadingDiv.textContent = 'Error: ' + e.message;
      }
    };
  </script>
</body>
</html>
