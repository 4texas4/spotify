<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spotify → YouTube Audio Playlist</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { background:#111; color:#fff; font-family:sans-serif; padding:1rem; text-align:center; }
    input, button { padding:0.6rem; font-size:1rem; border:none; border-radius:6px; margin:0.3rem }
    button { background:#1db954; color:#000; cursor:pointer; }
    #playlist { margin:1rem auto; max-width:600px; text-align:left; }
    .track { padding:0.5rem; cursor:pointer; border-bottom:1px solid #333; }
    .track.current { background:#1db954; color:#000; }
    #controls { margin-top:1rem; }
    #controls button { margin:0 0.5rem; }
    #embed { width:audio; height:0px; visibility:hidden; }
  </style>
</head>
<body>
  <h2>Spotify Playlist → YouTube Audio</h2>
  <input id="spotifyUrl" placeholder="Spotify playlist link" size="50"/>
  <button onclick="loadPlaylist()">Load</button>

  <div id="playlist"></div>

  <div id="controls" style="display:none;">
    <button onclick="prevTrack()">⏮ Prev</button>
    <button onclick="togglePlay()">⏯ Play/Pause</button>
    <button onclick="nextTrack()">⏭ Next</button>
    <button onclick="download()">⬇ Download</button>
    <div id="current"></div>
  </div>

  <div id="embed"></div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let tracks = [], current = 0, player, isPlaying = false;
    const cors = 'https://corsproxy.io/?';

    async function loadPlaylist() {
      const url = document.getElementById('spotifyUrl').value.trim();
      const m = url.match(/playlist\/([A-Za-z0-9]+)(\?|$)/);
      if (!m) return alert('Invalid Spotify link');
      document.getElementById('playlist').innerHTML = 'Loading...';

      try {
        const token = (await fetch('/api/token')).json().then(r => r.access_token);
        const res = await fetch(`https://api.spotify.com/v1/playlists/${m[1]}/tracks?limit=100`, {
          headers: { Authorization: 'Bearer ' + await token }
        });
        const js = await res.json();
        tracks = js.items.map(it => it.track)
          .filter(t => t && t.name && t.artists.length)
          .map(t => ({ q: `${t.name} ${t.artists[0].name}` }));

        const container = document.getElementById('playlist');
        container.innerHTML = tracks.map((t,i) =>
          `<div class="track" onclick="play(${i})">${t.q}</div>`).join('');

        if (tracks.length) {
          document.getElementById('controls').style.display = 'block';
          play(0);
        }
      } catch (e) {
        alert('Failed to load: ' + e.message);
      }
    }

    async function searchFirstVideo(q) {
      const html = await fetch(cors + `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`)
        .then(r=>r.text());
      const jm = html.match(/ytInitialData"\s*:\s*(\{.*?\})\s*;/s);
      if (!jm) throw 'YT data not found';
      const data = JSON.parse(jm[1]);
      const conts = data.contents.twoColumnSearchResultsRenderer.primaryContents
        .sectionListRenderer.contents;
      for (const s of conts) {
        const items = s.itemSectionRenderer?.contents;
        if (!items) continue;
        for (const it of items) {
          const vr = it.videoRenderer;
          if (vr && vr.videoId) return vr.videoId;
        }
      }
      throw 'No video found';
    }

    function play(i) {
      if (i < 0 || i >= tracks.length) return;
      current = i;
      updatePlaylist();
      startPlay();
    }

    function updatePlaylist() {
      document.querySelectorAll('.track').forEach((d, idx) =>
        d.classList.toggle('current', idx === current));
    }

    async function startPlay() {
      const q = tracks[current].q;
      document.getElementById('current').textContent = 'Loading: ' + q;
      try {
        const vid = await searchFirstVideo(q);
        if (player) player.loadVideoById(vid);
        else initPlayer(vid);
        isPlaying = true;
        updatePlayPause();
      } catch (e) {
        alert('Play error: ' + e);
      }
    }

    function initPlayer(vid) {
      player = new YT.Player('embed', {
        videoId: vid,
        playerVars: { autoplay:1, controls:0 },
        events: {
          onReady: e => e.target.playVideo(),
          onStateChange: e => {
            if (e.data === YT.PlayerState.PLAYING) isPlaying = true;
            if (e.data === YT.PlayerState.PAUSED) isPlaying = false;
            if (e.data === YT.PlayerState.ENDED) nextTrack();
          }
        }
      });
    }

    function togglePlay() {
      if (!player) return;
      if (isPlaying) player.pauseVideo();
      else player.playVideo();
    }

    function nextTrack() { play(current+1); }
    function prevTrack() { play(current-1); }
    function updatePlayPause() {
      document.querySelector('#controls button:nth-child(2)').textContent = isPlaying ? '⏸ Pause' : '▶️ Play';
      document.getElementById('current').textContent = (isPlaying ? 'Playing: ' : 'Paused: ') + tracks[current].q;
    }
    function download() {
      if (!player) return;
      const vid = player.getVideoData().video_id;
      window.open(`https://yt1d.com/en307/watch?v=${vid}`, '_blank');
    }
  </script>
</body>
</html>
